# Backend TZ — необходимые доработки API

Этот документ описывает изменения в API, необходимые для полноценной работы фронтенда.

## 1. [CRITICAL] GET /api/orders — фильтр `taken_by_me=true`

**Проблема:** Фронтенд для экрана "Мои заказы" (исполнитель) вынужден загружать **все** ордера и фильтровать клиентски по `taken_by[].executor_id`. Это не масштабируется.

**Требования:**
- Новый query-параметр: `taken_by_me=true`
- Возвращает только ордера, где текущий пользователь есть в `taken_by`
- Должен работать со всеми статусами (active, completed, expired, etc.)

**Пример запроса:**
```
GET /api/orders?taken_by_me=true
```

---

## 2. [CRITICAL] GET /api/orders/{id} и GET /api/orders — поле `rating` в ответе

**Проблема:** После завершения заказа, в истории отображается "Выполнен" без рейтинга. Фронтенд не может показать оценку, потому что `OrderResponse` не содержит поля `rating`.

**Требования:**
- Добавить в `OrderResponse` и `OrderDetailResponse`:
  ```json
  {
    "rating": 5,           // number | null — оценка от клиента
    "review_comment": "..."  // string | null — опционально, текст отзыва
  }
  ```
- `rating` заполняется из таблицы reviews по `order_id`
- Если отзыв ещё не оставлен — `null`

---

## 3. [HIGH] GET /api/reviews — фильтр `mine=true` / `executor_id`

**Проблема:** Экран "Отзывы" (доступен из профиля) показывает **все** отзывы системы. Пользователь ожидает видеть отзывы, связанные с ним.

**Требования:**
- Новые query-параметры:
  - `mine=true` — отзывы на заказы текущего пользователя (как клиента)
  - `about_me=true` — отзывы об исполнителе (текущий пользователь = executor)
- Оба фильтра опциональны; без них — текущее поведение (все отзывы)

**Пример:**
```
GET /api/reviews?mine=true        # мои отзывы (я — клиент)
GET /api/reviews?about_me=true    # отзывы обо мне (я — исполнитель)
```

---

## 4. [HIGH] GET /api/orders — пагинация

**Проблема:** Все запросы `/api/orders` возвращают полный список. При росте базы это станет узким местом.

**Требования:**
- Параметры `limit` и `offset` уже поддерживаются (фронтенд их передаёт), но нужно убедиться, что они работают корректно
- Дефолтный `limit` — 50 (или настраиваемый)
- В ответе уже есть `total` — оставить

---

## 5. [MEDIUM] POST /api/orders/{id}/complete — вернуть обновлённый ордер

**Проблема:** После вызова `complete`, фронтенд делает invalidate кеша и ждёт рефетча. Было бы эффективнее получить обновлённый ордер в ответе.

**Текущее поведение:** Возвращает `OrderResponse`  — OK, уже реализовано.

**Рекомендация:** Убедиться, что ответ содержит актуальный `status: 'completed'`.

---

## 6. [MEDIUM] Подтверждение существования review перед показом формы

**Проблема:** Фронтенд использует `localStorage` для блокировки повторной отправки отзыва (`useSubmittedGuard`). Это ненадёжно — другой браузер или очистка кеша позволит отправить дубликат.

**Требования:**
- `GET /api/reviews/check?order_id=<id>` — проверить, оставлен ли уже отзыв
  ```json
  { "submitted": true, "type": "review" | "complaint" }
  ```
- Или добавить `has_review: boolean` в `OrderDetailResponse`

---

## 7. [LOW] Webhook/notification для deep linking

**Проблема:** Deep linking (`t.me/bot?startapp=order_<id>`) реализован на фронтенде, но нотификации бота должны включать правильный формат ссылок.

**Требования:**
- При отправке Telegram-уведомлений о новых заказах, включать ссылку:
  ```
  https://t.me/<bot_username>?startapp=order_<order_id>
  ```
- Формат `startapp` параметра: `order_<uuid>`

---

## Сводная таблица

| # | Приоритет | Эндпоинт | Изменение |
|---|-----------|----------|-----------|
| 1 | CRITICAL | GET /api/orders | Параметр `taken_by_me=true` |
| 2 | CRITICAL | GET /api/orders, /api/orders/{id} | Поля `rating`, `review_comment` |
| 3 | HIGH | GET /api/reviews | Параметры `mine=true`, `about_me=true` |
| 4 | HIGH | GET /api/orders | Проверить пагинацию (limit/offset) |
| 5 | MEDIUM | POST /api/orders/{id}/complete | Убедиться что возвращает updated order |
| 6 | MEDIUM | GET /api/reviews/check | Серверная проверка дубликатов |
| 7 | LOW | Telegram Bot | Deep link формат в нотификациях |
