name: Rollback

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Version tag to rollback to (e.g. 0.2.0)"
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  rollback:
    name: Rollback to ${{ inputs.tag }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Lowercase repo name
        id: repo
        run: echo "name=${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

      - name: Deploy previous version via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}:${{ inputs.tag }}
            cd /opt/srochno
            TAG=${{ inputs.tag }} docker compose -f docker-compose.prod.yml up -d --force-recreate
            docker image prune -f
